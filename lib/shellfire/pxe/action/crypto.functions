# This file is part of pxe. It is subject to the licence terms in the COPYRIGHT file found in the top-level directory of this distribution and at https://raw.githubusercontent.com/lemonrock/pxe/master/COPYRIGHT. No part of pxe, including this file, may be copied, modified, propagated, or distributed except according to the terms contained in the COPYRIGHT file.
# Copyright Â© 2014-2015 The developers of pxe. See the COPYRIGHT file in the top-level directory of this distribution and at https://raw.githubusercontent.com/lemonrock/pxe/master/COPYRIGHT.


core_usesIn pxe openssl

pxe_action_new_certificate_authority()
{
	_pxe_action_crypto_generateCertificateAuthorityCertificate
	printf '%s\n' 1000 >"$pxe_certificateAuthorityFolderPath"/private-pxe-certificate-authority.srl
	printf '' >"$pxe_certificateAuthorityFolderPath"/private-pxe-certificate-authority.idx
	_pxe_action_crypto_generateNewServerAuthenticationCertificate
	_pxe_action_crypto_generateNewCodeSigningCertificate
}

pxe_action_new_client_certificate()
{
	_pxe_action_crypto_generateNewClientAuthenticationCertificate 'any'
}

core_dependency_requires '*' openssl
_pxe_action_crypto_generateCertificateAuthorityCertificate()
{
	openssl req -x509 -sha256 -newkey rsa:4096 -out "$pxe_certificateAuthorityCertFilePath" -keyout "$pxe_certificateAuthorityKeyFilePath" -days 10000
}

# TODO: These will eventually need to be embedded into stunnel
# TODO: Probably ought to store these in a client folder?
_pxe_action_crypto_generateNewServerAuthenticationCertificate()
{
	pxe_openssl_new_request 'server'
    pxe_openssl_ca 'server'
}

_pxe_action_crypto_generateNewCodeSigningCertificate()
{
	pxe_openssl_new_request 'code-signing'
	pxe_openssl_ca_sign 'code-signing' -extensions codesigning
}

# TODO: These will eventually need to be embedded into stunnel
# TODO: Probably ought to store these in a client folder?
_pxe_action_crypto_generateNewClientAuthenticationCertificate()
{
	local clientId="$1"
	pxe_openssl_new_request "$clientId".client
    pxe_openssl_ca "$clientId".client
}
